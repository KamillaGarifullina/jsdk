//<script type="module">
import { registerSw, publishSharedCtx, registerHandler } from '../sw-manager/sw-manager.js';

const params = new URL(location.href).searchParams;
const DEPL_ID = params.get('uuid');
const DOC = params.get('doc') || 'index.html';
const SKIP_CSV = params.get('skip') || '';
const DEPL_URL = `https://ucarecdn.com/${DEPL_ID}/`;
const DEVMODE_PROP = 'devmode';

async function displayDoc() {
  const swKey = await registerSw('../sw-manager/sw.js', './');

  let dMap = await (await window.fetch(DEPL_URL)).json();

  let proxyMap = {...dMap};
  delete proxyMap.__META__;

  let skipPath = ['index.html', DOC, DEPL_ID];
  if (SKIP_CSV) {
    skipPath = [...skipPath, ...SKIP_CSV.split(',')];
  }

  publishSharedCtx({
    skipPath,
    proxyMap,
  }, swKey);

  registerHandler('fetch', 'deployer-view-handler', (e, ctx, shared) => {
    let url = e.request.url;
    let skip = false;
    if (shared.skipPath) {
      shared.skipPath.forEach((skipStr) => {
        if (url.includes(skipStr)) {
          skip = true;
        }
      });
    }
    if (skip) {
      console.log('SKIPPED: ' + url);
    } else if (shared.proxyMap) {
      let reqPath = Object.keys(shared.proxyMap).find((path) => {
        return e.request.url.includes(path);
      });
      if (reqPath) {
        let paramsStr = e.request.url.split('?')[1] || '';
        let newRequest = new Request(shared.proxyMap[reqPath] + paramsStr);
        e.respondWith(self.fetch(newRequest));
      }
    }
  }, swKey);

  let docTxt = await (await window.fetch(dMap[DOC])).text();
  let newDoc = document.open();
  newDoc.write(docTxt);
  newDoc.close();
}

displayDoc();
//</script>